import asyncio # åœ¨è¿™ä¸ªå·¥å…·ä¸­å¯èƒ½ä¸éœ€è¦ï¼Œå› ä¸ºæ²¡æœ‰é˜»å¡çš„I/Oæ“ä½œ
from tools.base import BaseTool, ToolResult, ToolFailure # å‡è®¾è¿™äº›åŸºç±»å·²å®šä¹‰
from utils.logger import logger # å‡è®¾æ‚¨æœ‰ä¸€ä¸ªåä¸º logger çš„æ—¥å¿—è®°å½•å™¨

class FinalResponse(BaseTool):
    name: str = "final response" # å·¥å…·åç§°ï¼Œéµå¾ªå°å†™å’Œç©ºæ ¼çš„æ¨¡å¼
    description: str = """
    ä¸€ä¸ªç‰¹æ®Šçš„å·¥å…·ï¼Œç”¨äºå‘ç”¨æˆ·æä¾›æœ€ç»ˆçš„è¡ŒåŠ¨æ€»ç»“ã€ç»“æœæˆ–ç»“è®ºæ€§ç­”å¤ã€‚
    ä»…å½“æ‚¨å·²å®Œæˆå¤„ç†ç”¨æˆ·æŸ¥è¯¢çš„æ‰€æœ‰å¿…è¦æ­¥éª¤å¹¶å‡†å¤‡ç»“æŸäº¤äº’æ—¶ï¼Œæ‰åº”ä½¿ç”¨æ­¤å·¥å…·ã€‚
    è¿™é€šå¸¸æ˜¯åœ¨è°ƒç”¨ 'terminate' å·¥å…·ä¹‹å‰çš„æœ€åä¸€ä¸ªå·¥å…·ã€‚
    æ­¤å¤„æä¾›çš„å†…å®¹å°†è¢«è§†ä¸ºä»£ç†ç»™ç”¨æˆ·çš„æœ€ç»ˆè¾“å‡ºã€‚
    """
    strict: bool = True # å› ä¸ºæœ‰å¿…éœ€çš„å‚æ•°
    parameters: dict = {
        "type": "object",
        "properties": {
            "content_to_deliver": { # å‚æ•°åç§°
                "description": "éœ€è¦å‘ˆç°ç»™ç”¨æˆ·çš„å…¨é¢æœ€ç»ˆæ¶ˆæ¯ã€è¡ŒåŠ¨æ€»ç»“ã€è°ƒæŸ¥ç»“æœæˆ–ç›´æ¥ç­”æ¡ˆã€‚è¿™åº”è¯¥æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ã€å®Œæ•´çš„å›å¤ã€‚",
                "type": "string",
            }
        },
        "required": ["content_to_deliver"], # å£°æ˜ content_to_deliver æ˜¯å¿…éœ€çš„
    }

    async def execute(self, content_to_deliver: str):
        """
        æ‰§è¡Œæœ€ç»ˆå“åº”/æ€»ç»“çš„å‘ˆç°ã€‚

        å‚æ•°:
        - content_to_deliver: ä»£ç†å‡†å¤‡å¥½çš„ï¼Œè¦ä¼ è¾¾ç»™ç”¨æˆ·çš„æœ€ç»ˆå†…å®¹ã€‚
        """
        try:
            # ä½¿ç”¨ logger è®°å½•ä»£ç†çš„æœ€ç»ˆé™ˆè¿°
            # ä½¿ç”¨ ğŸ (ç»ˆç‚¹æ——å¸œ) è¡¨æƒ…ç¬¦å·æ¥è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæœ€ç»ˆæ­¥éª¤
            logger.info(f"ğŸ ä»£ç†çš„æœ€ç»ˆå›åº”: {content_to_deliver}")

            # æ­¤å·¥å…·çš„ä¸»è¦ç›®çš„æ˜¯è®©ä»£ç†æ­£å¼åœ°å£°æ˜å…¶æœ€ç»ˆè¾“å‡ºã€‚
            # ä»£ç†æ¡†æ¶å¯èƒ½ä¼šç›´æ¥ä½¿ç”¨æ­¤å·¥å…·çš„è¾“å‡ºï¼Œæˆ–è€…æ ¹æ®æ­¤å·¥å…·è¢«è°ƒç”¨çš„äº‹å®ï¼Œ
            # æ¥æ ‡å¿—ä¸»åŠ¨å¤„ç†çš„ç»“æŸå¹¶å°†æ­¤å†…å®¹ä½œä¸ºæœ€ç»ˆæ¶ˆæ¯å‘ˆç°ç»™ç”¨æˆ·ã€‚

            # ToolResult çš„ output å¯ä»¥ç¡®è®¤ä»£ç†å·²å£°æ˜äº†ä»€ä¹ˆã€‚
            return ToolResult(output=f"ä»£ç†å·²å¾—å‡ºä»¥ä¸‹æœ€ç»ˆå›åº”: {content_to_deliver}")
        except Exception as e:
            logger.error(f"âš ï¸ åœ¨ FinalResponse å·¥å…·ä¸­å‘ç”Ÿé”™è¯¯: {e}")
            # è¿™ä¸ªç®€å•çš„å·¥å…·æœ¬èº«ä¸å¤ªå¯èƒ½å¼•å‘å¼‚å¸¸ï¼Œé™¤é logger.info å¤±è´¥ã€‚
            # ä½†ä¸ºäº†ç¨³å¥æ€§ï¼Œè¿˜æ˜¯åŠ ä¸Šäº†å¼‚å¸¸å¤„ç†ã€‚
            raise ToolFailure(f"âš ï¸ ä¼ é€’æœ€ç»ˆå›åº”æ—¶å‘ç”Ÿé”™è¯¯: {e}")